<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">视频帧提取器 - 科技工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; /* Dark background for track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* Darker thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter on hover */
        }

        /* Frame wrapper custom styles for selection state */
        .frame-wrapper {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent; /* Default transparent border */
            border-radius: 0.75rem; /* rounded-lg */
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Deeper shadow for techy feel */
            background-color: #2d3748; /* Darker background for frames */
        }

        .frame-wrapper:hover {
            border-color: #6366f1; /* Tailwind indigo-500 on hover */
            transform: translateY(-2px); /* Slight lift on hover */
        }

        .frame-wrapper[data-selected="true"] {
            border-color: #4f46e5; /* Tailwind indigo-600 */
            border-width: 4px;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4); /* Glow effect for selected */
            transform: scale(1.02); /* Slightly larger when selected */
        }
        .frame-wrapper[data-selected="true"] .selection-indicator {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .selection-indicator {
            position: absolute;
            top: 0.5rem; /* top-2 */
            right: 0.5rem; /* right-2 */
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            background-color: #4f46e5; /* bg-indigo-600 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transform: scale(0.5) rotate(-45deg); /* Initial state for animation */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6); /* Subtle glow */
        }

        .time-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7); /* Darker for better contrast */
            color: #a78bfa; /* Light purple text */
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            backdrop-filter: blur(3px); /* Subtle blur for techy feel */
            -webkit-backdrop-filter: blur(3px);
        }

        .frame-wrapper:hover .time-overlay {
            opacity: 1;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #818cf8; /* Light blue spinner */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Button hover glow effect */
        .button-glow:hover {
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.6);
        }

        .language-toggle .active {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
        }

        /* Disabled button styles */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none; /* Prevents click events */
            box-shadow: none !important; /* Remove glow on disabled */
            transform: none !important; /* Remove scale on disabled */
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001; /* Higher than loading overlay */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #2d3748; /* Dark background */
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #e2e8f0; /* Light text */
            border: 1px solid #4a5568;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-black min-h-screen flex flex-col items-center justify-center font-sans text-gray-100 p-4">
    <div class="bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-6xl space-y-10 border border-gray-700 backdrop-filter backdrop-blur-sm bg-opacity-70">
        <div class="flex justify-end mb-4">
            <div class="language-toggle flex bg-gray-700 rounded-full p-1 shadow-inner">
                <button id="lang-zh" class="py-2 px-4 rounded-full text-sm font-semibold transition-colors duration-200" data-lang="zh">中文</button>
                <button id="lang-en" class="py-2 px-4 rounded-full text-sm font-semibold transition-colors duration-200" data-lang="en">English</button>
            </div>
        </div>

        <h1 class="text-5xl font-extrabold text-center text-indigo-400 mb-8 drop-shadow-lg tracking-wider">
            <span class="text-purple-400" data-lang-key="titlePart1">视频帧</span><span data-lang-key="titlePart2">提取器</span>
        </h1>

        <div class="flex flex-col items-center space-y-5">
            <label for="videoInput" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-full transition duration-300 ease-in-out transform hover:scale-105 shadow-xl button-glow flex items-center justify-center">
                <input type="file" id="videoInput" accept="video/*" class="hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <span data-lang-key="selectVideoFile">选择视频文件</span>
            </label>
            <span id="fileName" class="text-lg text-gray-400 font-medium tracking-wide" data-lang-key="noFileSelected">未选择文件</span>
        </div>

        <div class="relative w-full aspect-video bg-gray-900 rounded-2xl overflow-hidden shadow-inner border border-gray-700">
            <video id="videoPlayer" controls class="w-full h-full object-contain"></video>
            <div id="noVideoMessage" class="absolute inset-0 flex items-center justify-center text-gray-500 text-2xl bg-gray-900" style="display: flex;">
                <span data-lang-key="pleaseSelectVideo">请选择一个视频文件以开始</span>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row items-center justify-center space-y-6 lg:space-y-0 lg:space-x-8 mt-8">
            <button id="extractCurrentFrameBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 button-glow flex items-center btn-disabled" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span data-lang-key="extractCurrentFrame">提取当前帧</span>
            </button>

            <div class="flex items-center space-x-4 bg-gray-700 p-4 rounded-xl shadow-inner border border-gray-600">
                <label for="intervalInput" class="text-gray-300 font-medium text-lg" data-lang-key="intervalSeconds">间隔 (秒):</label>
                <input type="number" id="intervalInput" value="1" min="0.1" step="0.1" class="w-32 p-3 bg-gray-800 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-white text-lg">
                <button id="extractIntervalFramesBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 button-glow flex items-center btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 2v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span data-lang-key="extractIntervalFrames">按间隔提取帧</span>
                </button>
            </div>

            <button id="clearFramesBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 button-glow flex items-center btn-disabled" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span data-lang-key="clearFrames">清空帧</span>
            </button>
        </div>

        <div class="flex flex-col lg:flex-row items-center justify-center space-y-6 lg:space-y-0 lg:space-x-8 mt-8">
            <button id="downloadAllFramesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 button-glow flex items-center btn-disabled" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span data-lang-key="downloadAllFrames">下载所有帧 (ZIP)</span>
            </button>
            <button id="downloadSelectedFramesBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 button-glow flex items-center btn-disabled" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13l3-3m0 0l3 3m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                </svg>
                <span data-lang-key="downloadSelectedFrames">下载选中帧 (ZIP)</span>
            </button>
        </div>

        <div id="extractedFramesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 p-6 bg-gray-900 rounded-2xl shadow-inner max-h-96 overflow-y-auto border border-gray-700">
            </div>

        <div class="mt-10 pt-8 border-t border-gray-700 text-center space-y-6">
            <h2 class="text-3xl font-bold text-indigo-400" data-lang-key="appreciationTitle">感谢您的支持！</h2>
            <p class="text-gray-300 text-lg" data-lang-key="appreciationText">如果您觉得这个工具对您有帮助，请考虑赞赏支持开发者。</p>
            <div class="flex justify-center">
                <img src="wechat.png" alt="赞赏二维码" class="w-48 h-48 rounded-lg shadow-xl border-2 border-gray-600 object-contain">
            </div>
            <p class="text-gray-400 text-sm" data-lang-key="qrCodeNote">扫码支持</p>
        </div>

        <canvas id="hiddenCanvas" class="hidden"></canvas>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="text-2xl font-semibold tracking-wide" data-lang-key="loadingMessage">正在打包下载，请稍候...</p>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" data-lang-key="confirmTitle">确认操作</h3>
            <p class="mb-6" data-lang-key="confirmMessage">您确定要清空所有已提取的帧吗？此操作不可撤销。</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmClearBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-lg transition duration-300 ease-in-out shadow-md">
                    <span data-lang-key="confirmYes">确定</span>
                </button>
                <button id="cancelClearBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-lg transition duration-300 ease-in-out shadow-md">
                    <span data-lang-key="confirmNo">取消</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const videoInput = document.getElementById('videoInput');
        const fileNameSpan = document.getElementById('fileName');
        const videoPlayer = document.getElementById('videoPlayer');
        const noVideoMessage = document.getElementById('noVideoMessage');
        const extractCurrentFrameBtn = document.getElementById('extractCurrentFrameBtn');
        const intervalInput = document.getElementById('intervalInput');
        const extractIntervalFramesBtn = document.getElementById('extractIntervalFramesBtn');
        const clearFramesBtn = document.getElementById('clearFramesBtn');
        const downloadAllFramesBtn = document.getElementById('downloadAllFramesBtn');
        const downloadSelectedFramesBtn = document.getElementById('downloadSelectedFramesBtn');
        const extractedFramesContainer = document.getElementById('extractedFramesContainer');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const ctx = hiddenCanvas.getContext('2d');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const langZhBtn = document.getElementById('lang-zh');
        const langEnBtn = document.getElementById('lang-en');

        // Modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        const confirmTitle = document.getElementById('confirmationModal').querySelector('[data-lang-key="confirmTitle"]');
        const confirmMessage = document.getElementById('confirmationModal').querySelector('[data-lang-key="confirmMessage"]');
        const confirmYes = document.getElementById('confirmClearBtn').querySelector('[data-lang-key="confirmYes"]');
        const confirmNo = document.getElementById('cancelClearBtn').querySelector('[data-lang-key="confirmNo"]');


        let videoDuration = 0;
        let intervalExtractionTimer = null; // Used to store the timer ID
        let frameCounter = 0; // Used for naming downloaded frames

        // Translations object
        const translations = {
            zh: {
                pageTitle: '视频帧提取器 - 科技工具',
                titlePart1: '视频帧',
                titlePart2: '提取器',
                selectVideoFile: '选择视频文件',
                noFileSelected: '未选择文件',
                pleaseSelectVideo: '请选择一个视频文件以开始',
                extractCurrentFrame: '提取当前帧',
                intervalSeconds: '间隔 (秒):',
                extractIntervalFrames: '按间隔提取帧',
                clearFrames: '清空帧',
                downloadAllFrames: '下载所有帧 (ZIP)',
                downloadSelectedFrames: '下载选中帧 (ZIP)',
                appreciationTitle: '感谢您的支持！',
                appreciationText: '如果您觉得这个工具对您有帮助，请考虑赞赏支持开发者。',
                qrCodeNote: '（请替换为您的实际赞赏二维码）',
                loadingMessage: '正在打包下载，请稍候...',
                alertNoFrames: '没有可下载的帧。',
                alertSelectOneFrame: '请选择至少一帧进行下载。',
                alertInvalidInterval: '请输入有效的间隔时间（大于0）。',
                stopExtraction: '停止提取',
                extractionComplete: '按间隔提取帧完成。',
                downloadError: '打包下载失败，请稍后再试。',
                noVideoFile: '未加载视频文件。',
                confirmTitle: '确认操作',
                confirmMessage: '您确定要清空所有已提取的帧吗？此操作不可撤销。',
                confirmYes: '确定',
                confirmNo: '取消',
                refreshConfirm: '刷新页面将丢失所有已提取的帧。您确定要继续吗？'
            },
            en: {
                pageTitle: 'Video Frame Extractor - Tech Tool',
                titlePart1: 'Video Frame',
                titlePart2: 'Extractor',
                selectVideoFile: 'Select Video File',
                noFileSelected: 'No file selected',
                pleaseSelectVideo: 'Please select a video file to start',
                extractCurrentFrame: 'Extract Current Frame',
                intervalSeconds: 'Interval (seconds):',
                extractIntervalFrames: 'Extract Frames by Interval',
                clearFrames: 'Clear Frames',
                downloadAllFrames: 'Download All Frames (ZIP)',
                downloadSelectedFrames: 'Download Selected Frames (ZIP)',
                appreciationTitle: 'Thank You for Your Support!',
                appreciationText: 'If you find this tool helpful, please consider supporting the developer with a donation.',
                qrCodeNote: '(Please replace with your actual QR Code)',
                loadingMessage: 'Packaging for download, please wait...',
                alertNoFrames: 'No frames available for download.',
                alertSelectOneFrame: 'Please select at least one frame to download.',
                alertInvalidInterval: 'Please enter a valid interval (greater than 0).',
                stopExtraction: 'Stop Extraction',
                extractionComplete: 'Interval frame extraction complete.',
                downloadError: 'Packaging for download failed, please try again later.',
                noVideoFile: 'No video file loaded.',
                confirmTitle: 'Confirm Action',
                confirmMessage: 'Are you sure you want to clear all extracted frames? This action cannot be undone.',
                confirmYes: 'Confirm',
                confirmNo: 'Cancel',
                refreshConfirm: 'Refreshing the page will clear all extracted frames. Are you sure you want to proceed?'
            }
        };

        // Function to set the language
        function setLanguage(lang) {
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            // Update specific elements that need special handling
            document.title = translations[lang]['pageTitle'];
            fileNameSpan.textContent = videoInput.files[0] ? videoInput.files[0].name : translations[lang]['noFileSelected'];
            
            // Update active button styling
            langZhBtn.classList.remove('active');
            langEnBtn.classList.remove('active');
            if (lang === 'zh') {
                langZhBtn.classList.add('active');
            } else {
                langEnBtn.classList.add('active');
            }

            localStorage.setItem('currentLang', lang); // Save language preference
        }

        // Function to update button states (enabled/disabled)
        function updateButtonStates() {
            const hasVideo = !!videoPlayer.src;
            const hasFrames = extractedFramesContainer.children.length > 0;
            const hasSelectedFrames = extractedFramesContainer.querySelectorAll('.frame-wrapper[data-selected="true"]').length > 0;

            // Enable/disable extraction buttons based on video presence
            extractCurrentFrameBtn.disabled = !hasVideo;
            extractIntervalFramesBtn.disabled = !hasVideo;

            // Enable/disable frame management/download buttons based on frames presence
            clearFramesBtn.disabled = !hasFrames;
            downloadAllFramesBtn.disabled = !hasFrames;
            
            // Enable/disable selected frames download button based on selected frames presence
            downloadSelectedFramesBtn.disabled = !hasSelectedFrames;

            // Apply/remove disabled class for visual feedback
            [extractCurrentFrameBtn, extractIntervalFramesBtn, clearFramesBtn, downloadAllFramesBtn, downloadSelectedFramesBtn].forEach(button => {
                if (button.disabled) {
                    button.classList.add('btn-disabled');
                } else {
                    button.classList.remove('btn-disabled');
                }
            });
        }

        // Initialize language on page load
        const savedLang = localStorage.getItem('currentLang') || 'zh'; // Default to Chinese
        setLanguage(savedLang);
        updateButtonStates(); // Set initial button states

        // Language toggle event listeners
        langZhBtn.addEventListener('click', () => setLanguage('zh'));
        langEnBtn.addEventListener('click', () => setLanguage('en'));

        // Handle video file selection
        videoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                const videoURL = URL.createObjectURL(file);
                videoPlayer.src = videoURL;
                noVideoMessage.style.display = 'none'; // Hide the message
                videoPlayer.load(); // Load the video
                // Clear extracted frames and reset counter
                extractedFramesContainer.innerHTML = '';
                frameCounter = 0;
            } else {
                fileNameSpan.textContent = translations[localStorage.getItem('currentLang') || 'zh']['noFileSelected'];
                videoPlayer.src = '';
                noVideoMessage.style.display = 'flex'; // Show the message
            }
            updateButtonStates(); // Update button states after video selection
        });

        // Get duration and set canvas dimensions after video metadata is loaded
        videoPlayer.addEventListener('loadedmetadata', () => {
            videoDuration = videoPlayer.duration;
            hiddenCanvas.width = videoPlayer.videoWidth;
            hiddenCanvas.height = videoPlayer.videoHeight;
            updateButtonStates(); // Update button states once video metadata is loaded
        });

        /**
         * Downloads frames as a ZIP file.
         * @param {NodeListOf<Element>} frameElements - A NodeList of frame wrapper elements.
         * @param {string} zipFilename - The desired filename for the ZIP file.
         */
        async function downloadFramesAsZip(frameElements, zipFilename) {
            if (frameElements.length === 0) {
                alert(translations[localStorage.getItem('currentLang') || 'zh']['alertNoFrames']);
                return;
            }

            loadingOverlay.classList.remove('hidden'); // Show loading overlay
            const zip = new JSZip();

            try {
                for (let i = 0; i < frameElements.length; i++) {
                    const frameWrapper = frameElements[i];
                    const imgDataUrl = frameWrapper.getAttribute('data-img-src');
                    const filename = frameWrapper.getAttribute('data-filename');

                    // Fetch the image data and convert to Blob
                    const response = await fetch(imgDataUrl);
                    const blob = await response.blob();

                    // Add to zip file
                    zip.file(filename, blob);
                }

                // Generate the ZIP file
                const content = await zip.generateAsync({ type: "blob" });

                // Save the ZIP file using FileSaver.js
                saveAs(content, zipFilename);

            } catch (error) {
                console.error('打包下载时发生错误:', error);
                alert(translations[localStorage.getItem('currentLang') || 'zh']['downloadError']);
            } finally {
                loadingOverlay.classList.add('hidden'); // Hide loading overlay
            }
        }

        // Function to extract a frame
        function extractFrame(time) {
            if (!videoPlayer.src) {
                console.error(translations[localStorage.getItem('currentLang') || 'zh']['noVideoFile']);
                return;
            }

            // If a specific time is provided, seek to that time
            if (time !== undefined) {
                videoPlayer.currentTime = time;
            }

            // Ensure the video is ready to draw the frame
            videoPlayer.addEventListener('seeked', function onSeeked() {
                // Draw video frame to canvas
                ctx.drawImage(videoPlayer, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

                // Convert canvas content to image URL
                const imgDataUrl = hiddenCanvas.toDataURL('image/png');
                frameCounter++;
                const filename = `frame_at_${videoPlayer.currentTime.toFixed(2)}s_no_${frameCounter}.png`;

                // Create img element and its wrapper, then add to container
                const frameWrapper = document.createElement('div');
                frameWrapper.classList.add('frame-wrapper');
                frameWrapper.setAttribute('data-selected', 'false');
                frameWrapper.setAttribute('data-img-src', imgDataUrl); // Store image data URL for download
                frameWrapper.setAttribute('data-filename', filename); // Store filename for download

                const imgElement = document.createElement('img');
                imgElement.src = imgDataUrl;
                imgElement.alt = `Frame at ${videoPlayer.currentTime.toFixed(2)}s`;
                imgElement.classList.add('w-full', 'h-auto', 'object-contain', 'rounded-md');

                const timeOverlay = document.createElement('div');
                timeOverlay.classList.add('time-overlay');
                timeOverlay.textContent = `${videoPlayer.currentTime.toFixed(2)}s`;

                const selectionIndicator = document.createElement('div');
                selectionIndicator.classList.add('selection-indicator');
                selectionIndicator.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

                frameWrapper.appendChild(imgElement);
                frameWrapper.appendChild(timeOverlay);
                frameWrapper.appendChild(selectionIndicator);
                extractedFramesContainer.appendChild(frameWrapper);

                // Add click event listener to select/deselect frame
                frameWrapper.addEventListener('click', () => {
                    const isSelected = frameWrapper.getAttribute('data-selected') === 'true';
                    frameWrapper.setAttribute('data-selected', !isSelected);
                    updateButtonStates(); // Update button states after selection change
                });

                // Remove event listener to prevent multiple triggers
                videoPlayer.removeEventListener('seeked', onSeeked);
                updateButtonStates(); // Update button states after a new frame is added
            }, { once: true }); // Use { once: true } to ensure event triggers only once

            // If no specific time is provided, draw the current frame directly (after loadedmetadata)
            if (time === undefined) {
                // Draw video frame to canvas
                ctx.drawImage(videoPlayer, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

                // Convert canvas content to image URL
                const imgDataUrl = hiddenCanvas.toDataURL('image/png');
                frameCounter++;
                const filename = `frame_at_${videoPlayer.currentTime.toFixed(2)}s_no_${frameCounter}.png`;

                // Create img element and its wrapper, then add to container
                const frameWrapper = document.createElement('div');
                frameWrapper.classList.add('frame-wrapper');
                frameWrapper.setAttribute('data-selected', 'false');
                frameWrapper.setAttribute('data-img-src', imgDataUrl); // Store image data URL for download
                frameWrapper.setAttribute('data-filename', filename); // Store filename for download

                const imgElement = document.createElement('img');
                imgElement.src = imgDataUrl;
                imgElement.alt = `Frame at ${videoPlayer.currentTime.toFixed(2)}s`;
                imgElement.classList.add('w-full', 'h-auto', 'object-contain', 'rounded-md');

                const timeOverlay = document.createElement('div');
                timeOverlay.classList.add('time-overlay');
                timeOverlay.textContent = `${videoPlayer.currentTime.toFixed(2)}s`;

                const selectionIndicator = document.createElement('div');
                selectionIndicator.classList.add('selection-indicator');
                selectionIndicator.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

                frameWrapper.appendChild(imgElement);
                frameWrapper.appendChild(timeOverlay);
                frameWrapper.appendChild(selectionIndicator);
                extractedFramesContainer.appendChild(frameWrapper);

                // Add click event listener to select/deselect frame
                frameWrapper.addEventListener('click', () => {
                    const isSelected = frameWrapper.getAttribute('data-selected') === 'true';
                    frameWrapper.setAttribute('data-selected', !isSelected);
                    updateButtonStates(); // Update button states after selection change
                });
                updateButtonStates(); // Update button states after a new frame is added
            }
        }

        // Bind extract current frame button event
        extractCurrentFrameBtn.addEventListener('click', () => {
            extractFrame(); // Extract frame at current playback time
        });

        // Bind extract interval frames button event
        extractIntervalFramesBtn.addEventListener('click', () => {
            if (!videoPlayer.src) {
                console.error(translations[localStorage.getItem('currentLang') || 'zh']['noVideoFile']);
                return;
            }

            // Clear previous timer to prevent duplicate starts
            if (intervalExtractionTimer) {
                clearInterval(intervalExtractionTimer);
                intervalExtractionTimer = null;
                extractIntervalFramesBtn.textContent = translations[localStorage.getItem('currentLang') || 'zh']['extractIntervalFrames'];
                console.log(translations[localStorage.getItem('currentLang') || 'zh']['extractionComplete']);
                return; // If extracting, clicking the button stops it
            }

            const interval = parseFloat(intervalInput.value);
            if (isNaN(interval) || interval <= 0) {
                alert(translations[localStorage.getItem('currentLang') || 'zh']['alertInvalidInterval']);
                return;
            }

            // Change button text to indicate active extraction
            extractIntervalFramesBtn.textContent = translations[localStorage.getItem('currentLang') || 'zh']['stopExtraction'];

            let currentTime = 0;
            // Ensure extraction starts from the beginning of the video
            videoPlayer.currentTime = 0;

            const startExtraction = () => {
                if (currentTime <= videoDuration) {
                    extractFrame(currentTime);
                    currentTime += interval;
                } else {
                    clearInterval(intervalExtractionTimer);
                    intervalExtractionTimer = null;
                    extractIntervalFramesBtn.textContent = translations[localStorage.getItem('currentLang') || 'zh']['extractIntervalFrames'];
                    console.log(translations[localStorage.getItem('currentLang') || 'zh']['extractionComplete']);
                }
                updateButtonStates(); // Update button states after extraction
            };

            // Execute first time immediately, then set timer
            startExtraction();
            intervalExtractionTimer = setInterval(startExtraction, interval * 1000); // Convert to milliseconds
        });

        // Bind clear frames button event - show confirmation modal
        clearFramesBtn.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
            // Update modal text based on current language
            const currentLang = localStorage.getItem('currentLang') || 'zh';
            confirmTitle.textContent = translations[currentLang]['confirmTitle'];
            confirmMessage.textContent = translations[currentLang]['confirmMessage'];
            confirmYes.textContent = translations[currentLang]['confirmYes'];
            confirmNo.textContent = translations[currentLang]['confirmNo'];
        });

        // Handle confirmation for clearing frames
        confirmClearBtn.addEventListener('click', () => {
            extractedFramesContainer.innerHTML = ''; // Clear container content
            frameCounter = 0; // Reset counter
            // Stop any ongoing interval extraction
            if (intervalExtractionTimer) {
                clearInterval(intervalExtractionTimer);
                intervalExtractionTimer = null;
                extractIntervalFramesBtn.textContent = translations[localStorage.getItem('currentLang') || 'zh']['extractIntervalFrames'];
            }
            confirmationModal.classList.add('hidden'); // Hide modal
            updateButtonStates(); // Update button states after clearing frames
        });

        cancelClearBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden'); // Hide modal
        });

        // Bind download all frames button event
        downloadAllFramesBtn.addEventListener('click', () => {
            const allFrames = extractedFramesContainer.querySelectorAll('.frame-wrapper');
            downloadFramesAsZip(allFrames, '所有抽帧.zip');
        });

        // Bind download selected frames button event
        downloadSelectedFramesBtn.addEventListener('click', () => {
            const selectedFrames = extractedFramesContainer.querySelectorAll('.frame-wrapper[data-selected="true"]');
            if (selectedFrames.length === 0) {
                alert(translations[localStorage.getItem('currentLang') || 'zh']['alertSelectOneFrame']);
                return;
            }
            downloadFramesAsZip(selectedFrames, '选中抽帧.zip');
        });

        // Add confirmation for page refresh/unload
        window.onbeforeunload = function() {
            // Only show confirmation if there are extracted frames
            if (extractedFramesContainer.children.length > 0) {
                return translations[localStorage.getItem('currentLang') || 'zh']['refreshConfirm'];
            }
        };
    </script>
</body>
</html>
