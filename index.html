<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">视频帧提取器 - 科技工具</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        /* Frame wrapper custom styles */
        .frame-wrapper {
            position: relative;
            cursor: pointer;
            border: 2px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem; /* rounded-md */
            overflow: hidden;
            transition: all 0.2s ease-in-out;
            background-color: #374151; /* gray-700 */
        }
        .frame-wrapper:hover {
            border-color: #6366f1; /* indigo-500 */
            transform: scale(1.03);
        }
        .frame-wrapper[data-selected="true"] {
            border-color: #4f46e5; /* indigo-600 */
            border-width: 3px; /* Slightly thicker for selected */
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
        }
        .frame-wrapper[data-selected="true"] .selection-indicator {
            opacity: 1;
            transform: scale(1);
        }

        .selection-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.75rem; /* w-7 */
            height: 1.75rem; /* h-7 */
            background-color: #4f46e5; /* indigo-600 */
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease-in-out;
        }

        .time-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: #c7d2fe; /* indigo-200 */
            font-size: 0.75rem; /* text-xs */
            padding: 0.25rem 0.5rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .frame-wrapper:hover .time-overlay {
            opacity: 1;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8); /* gray-900 with opacity */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem; /* text-xl */
            z-index: 1000;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out forwards;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #818cf8; /* indigo-400 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Button base styles */
        .btn {
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* semibold */
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid transparent;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0px);
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #4b5563; /* gray-600 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #374151; /* gray-700 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .btn-success {
            background-color: #16a34a; /* green-600 */
            color: white;
        }
        .btn-success:hover {
            background-color: #15803d; /* green-700 */
        }
        .btn-teal {
            background-color: #0d9488; /* teal-600 */
            color: white;
        }
        .btn-teal:hover {
            background-color: #0f766e; /* teal-700 */
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            transform: none !important;
        }
        .btn svg {
            margin-right: 0.5rem; /* mr-2 */
        }

        .language-toggle button {
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            color: #9ca3af; /* gray-400 */
        }
        .language-toggle button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .language-toggle button:not(.active):hover {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
        }


        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8); /* gray-900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #1f2937; /* gray-800 */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 450px;
            width: 90%;
            color: #d1d5db; /* gray-300 */
            border: 1px solid #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center justify-start font-sans text-gray-200 p-4 md:p-8">
    
    <header class="w-full max-w-6xl mx-auto mb-8 flex justify-between items-center py-4 px-2">
        <h1 class="text-3xl md:text-4xl font-bold text-indigo-400">
            <span class="text-purple-400" data-lang-key="titlePart1">视频帧</span><span data-lang-key="titlePart2">提取器</span>
        </h1>
        <div class="language-toggle flex bg-gray-800 rounded-full p-1 shadow-md">
            <button id="lang-zh" class="active" data-lang="zh">中文</button>
            <button id="lang-en" data-lang="en">English</button>
        </div>
    </header>

    <main class="bg-gray-800 p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-6xl space-y-8 border border-gray-700">
        
        <section id="upload-section" class="space-y-6">
            <div class="flex flex-col items-center space-y-4">
                <label for="videoInput" class="btn btn-primary cursor-pointer shadow-lg hover:shadow-indigo-500/50">
                    <input type="file" id="videoInput" accept="video/*" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span data-lang-key="selectVideoFile">选择视频文件</span>
                </label>
                <span id="fileName" class="text-sm text-gray-400" data-lang-key="noFileSelected">未选择文件</span>
            </div>

            <div id="dropZone" class="w-full aspect-video bg-gray-900 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-600 hover:border-indigo-500 transition-colors duration-200">
                <video id="videoPlayer" controls class="w-full h-full object-contain hidden"></video>
                <div id="noVideoMessage" class="text-center text-gray-500 p-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-3 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <p class="text-lg font-semibold" data-lang-key="pleaseSelectVideo">请选择或拖放视频文件</p>
                    <p class="text-xs text-gray-600" data-lang-key="dragDropHint">将视频文件拖拽到此区域即可上传</p>
                </div>
            </div>
        </section>

        <section id="controls-section" class="space-y-6 border-t border-gray-700 pt-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-end">
                <div class="space-y-2">
                    <label for="intervalInput" class="block text-sm font-medium text-gray-300" data-lang-key="intervalSeconds">提取间隔 (秒):</label>
                    <input type="number" id="intervalInput" value="1" min="0.1" step="0.1" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                </div>
                <button id="extractIntervalFramesBtn" class="btn bg-purple-600 hover:bg-purple-700 btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 2v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span data-lang-key="extractIntervalFrames">按间隔提取帧</span>
                </button>
                 <button id="extractCurrentFrameBtn" class="btn btn-success btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span data-lang-key="extractCurrentFrame">提取当前帧</span>
                </button>
            </div>
             <div class="flex flex-wrap gap-4 justify-center pt-4 border-t border-gray-700">
                <button id="downloadAllFramesBtn" class="btn btn-secondary btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span data-lang-key="downloadAllFrames">下载所有帧 (ZIP)</span>
                </button>
                <button id="downloadSelectedFramesBtn" class="btn btn-teal btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 13l3-3m0 0l3 3m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    <span data-lang-key="downloadSelectedFrames">下载选中帧 (ZIP)</span>
                </button>
                <button id="clearFramesBtn" class="btn btn-danger btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span data-lang-key="clearFrames">清空帧</span>
                </button>
            </div>
        </section>

        <section id="frames-display-section" class="border-t border-gray-700 pt-8">
            <h3 class="text-xl font-semibold text-gray-300 mb-4" data-lang-key="extractedFramesTitle">提取的帧</h3>
            <div id="extractedFramesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-4 bg-gray-900 rounded-lg min-h-[150px] max-h-96 overflow-y-auto border border-gray-700">
                </div>
        </section>

        <footer class="mt-10 pt-8 border-t border-gray-700 text-center space-y-4">
            <h2 class="text-2xl font-semibold text-indigo-400" data-lang-key="appreciationTitle">感谢您的支持！</h2>
            <p class="text-gray-400" data-lang-key="appreciationText">如果您觉得这个工具对您有帮助，请考虑赞赏支持开发者。</p>
            <div class="flex justify-center">
                <img src="wechat.png" alt="赞赏二维码" class="w-40 h-40 rounded-lg shadow-lg border-2 border-gray-600 object-contain">
            </div>
        </footer>

        <canvas id="hiddenCanvas" class="hidden"></canvas>
    </main>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="text-xl font-medium tracking-wide" data-lang-key="loadingMessage">正在打包下载，请稍候...</p>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-3" data-lang-key="confirmTitle">确认操作</h3>
            <p class="mb-5 text-sm" data-lang-key="confirmMessage">您确定要清空所有已提取的帧吗？此操作不可撤销。</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelClearBtn" class="btn btn-secondary">
                    <span data-lang-key="confirmNo">取消</span>
                </button>
                <button id="confirmClearBtn" class="btn btn-danger">
                    <span data-lang-key="confirmYes">确定</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const videoInput = document.getElementById('videoInput');
        const fileNameSpan = document.getElementById('fileName');
        const videoPlayer = document.getElementById('videoPlayer');
        const noVideoMessage = document.getElementById('noVideoMessage');
        const extractCurrentFrameBtn = document.getElementById('extractCurrentFrameBtn');
        const intervalInput = document.getElementById('intervalInput');
        const extractIntervalFramesBtn = document.getElementById('extractIntervalFramesBtn');
        const clearFramesBtn = document.getElementById('clearFramesBtn');
        const downloadAllFramesBtn = document.getElementById('downloadAllFramesBtn');
        const downloadSelectedFramesBtn = document.getElementById('downloadSelectedFramesBtn');
        const extractedFramesContainer = document.getElementById('extractedFramesContainer');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const ctx = hiddenCanvas.getContext('2d');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const langZhBtn = document.getElementById('lang-zh');
        const langEnBtn = document.getElementById('lang-en');

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        
        const dropZone = document.getElementById('dropZone');

        let videoDuration = 0;
        let intervalExtractionTimer = null;
        let frameCounter = 0;

        const translations = {
            zh: {
                pageTitle: '视频帧提取器 - 专业版',
                titlePart1: '视频帧',
                titlePart2: '提取器',
                selectVideoFile: '选择视频文件',
                noFileSelected: '未选择文件',
                pleaseSelectVideo: '请选择或拖放视频文件',
                dragDropHint: '将视频文件拖拽到此区域即可上传',
                extractCurrentFrame: '提取当前帧',
                intervalSeconds: '提取间隔 (秒):',
                extractIntervalFrames: '按间隔提取',
                clearFrames: '清空帧',
                downloadAllFrames: '下载所有帧 (ZIP)',
                downloadSelectedFrames: '下载选中帧 (ZIP)',
                extractedFramesTitle: '提取的帧',
                appreciationTitle: '感谢您的支持！',
                appreciationText: '如果您觉得这个工具对您有帮助，请考虑赞赏支持开发者。',
                loadingMessage: '正在打包下载，请稍候...',
                alertNoFrames: '没有可下载的帧。',
                alertSelectOneFrame: '请选择至少一帧进行下载。',
                alertInvalidInterval: '请输入有效的间隔时间（大于0）。',
                stopExtraction: '停止提取',
                extractionComplete: '按间隔提取帧完成。',
                downloadError: '打包下载失败，请稍后再试。',
                noVideoFile: '未加载视频文件。',
                confirmTitle: '确认操作',
                confirmMessage: '您确定要清空所有已提取的帧吗？此操作不可撤销。',
                confirmYes: '确定',
                confirmNo: '取消',
                refreshConfirm: '刷新页面将丢失所有已提取的帧。您确定要继续吗？'
            },
            en: {
                pageTitle: 'Video Frame Extractor - Pro',
                titlePart1: 'Video Frame',
                titlePart2: 'Extractor',
                selectVideoFile: 'Select Video File',
                noFileSelected: 'No file selected',
                pleaseSelectVideo: 'Please select or drag & drop a video file',
                dragDropHint: 'Drag and drop video files here to upload',
                extractCurrentFrame: 'Extract Current Frame',
                intervalSeconds: 'Extraction Interval (sec):',
                extractIntervalFrames: 'Extract by Interval',
                clearFrames: 'Clear Frames',
                downloadAllFrames: 'Download All Frames (ZIP)',
                downloadSelectedFrames: 'Download Selected Frames (ZIP)',
                extractedFramesTitle: 'Extracted Frames',
                appreciationTitle: 'Thank You for Your Support!',
                appreciationText: 'If you find this tool helpful, please consider supporting the developer with a donation.',
                loadingMessage: 'Packaging for download, please wait...',
                alertNoFrames: 'No frames available for download.',
                alertSelectOneFrame: 'Please select at least one frame to download.',
                alertInvalidInterval: 'Please enter a valid interval (greater than 0).',
                stopExtraction: 'Stop Extraction',
                extractionComplete: 'Interval frame extraction complete.',
                downloadError: 'Packaging for download failed, please try again later.',
                noVideoFile: 'No video file loaded.',
                confirmTitle: 'Confirm Action',
                confirmMessage: 'Are you sure you want to clear all extracted frames? This action cannot be undone.',
                confirmYes: 'Confirm',
                confirmNo: 'Cancel',
                refreshConfirm: 'Refreshing the page will clear all extracted frames. Are you sure you want to proceed?'
            }
        };

        function setLanguage(lang) {
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            document.title = translations[lang]['pageTitle'];
            fileNameSpan.textContent = videoInput.files[0] ? videoInput.files[0].name : translations[lang]['noFileSelected'];
            
            langZhBtn.classList.toggle('active', lang === 'zh');
            langEnBtn.classList.toggle('active', lang === 'en');
            localStorage.setItem('currentLang', lang);
        }

        function updateButtonStates() {
            const hasVideo = !!videoPlayer.src && videoPlayer.readyState >= 2; // readyState 2 (HAVE_CURRENT_DATA) means video metadata is loaded
            const hasFrames = extractedFramesContainer.children.length > 0;
            const hasSelectedFrames = extractedFramesContainer.querySelectorAll('.frame-wrapper[data-selected="true"]').length > 0;

            extractCurrentFrameBtn.disabled = !hasVideo;
            extractIntervalFramesBtn.disabled = !hasVideo;
            clearFramesBtn.disabled = !hasFrames;
            downloadAllFramesBtn.disabled = !hasFrames;
            downloadSelectedFramesBtn.disabled = !hasSelectedFrames;

            [extractCurrentFrameBtn, extractIntervalFramesBtn, clearFramesBtn, downloadAllFramesBtn, downloadSelectedFramesBtn].forEach(button => {
                button.classList.toggle('btn-disabled', button.disabled);
            });
        }

        const savedLang = localStorage.getItem('currentLang') || 'zh';
        setLanguage(savedLang);
        updateButtonStates();

        langZhBtn.addEventListener('click', () => setLanguage('zh'));
        langEnBtn.addEventListener('click', () => setLanguage('en'));

        function processVideoSource(source) {
            let videoSource = null;
            let videoFileName = translations[localStorage.getItem('currentLang') || 'zh']['noFileSelected'];

            if (source && source.type && source.type.startsWith('video/')) {
                videoSource = URL.createObjectURL(source);
                videoFileName = source.name;
                videoPlayer.classList.remove('hidden');
                noVideoMessage.classList.add('hidden');
            } else {
                alert('请选择一个有效的视频文件。');
                videoPlayer.src = '';
                videoPlayer.classList.add('hidden');
                noVideoMessage.classList.remove('hidden');
                fileNameSpan.textContent = translations[localStorage.getItem('currentLang') || 'zh']['noFileSelected'];
                updateButtonStates();
                return;
            }
            
            fileNameSpan.textContent = videoFileName;
            videoPlayer.src = videoSource;
            videoPlayer.load(); 
            extractedFramesContainer.innerHTML = '';
            frameCounter = 0;
            updateButtonStates();
        }

        videoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            processVideoSource(file);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-indigo-500', 'bg-gray-700');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-indigo-500', 'bg-gray-700');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-indigo-500', 'bg-gray-700');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processVideoSource(files[0]);
            }
        });

        videoPlayer.addEventListener('loadedmetadata', () => {
            videoDuration = videoPlayer.duration;
            hiddenCanvas.width = videoPlayer.videoWidth;
            hiddenCanvas.height = videoPlayer.videoHeight;
            updateButtonStates();
        });

        async function downloadFramesAsZip(frameElements, zipFilename) {
            if (frameElements.length === 0) {
                alert(translations[localStorage.getItem('currentLang') || 'zh']['alertNoFrames']);
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const zip = new JSZip();
            try {
                for (let i = 0; i < frameElements.length; i++) {
                    const frameWrapper = frameElements[i];
                    const imgDataUrl = frameWrapper.getAttribute('data-img-src');
                    const filename = frameWrapper.getAttribute('data-filename');
                    const response = await fetch(imgDataUrl);
                    const blob = await response.blob();
                    zip.file(filename, blob);
                }
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, zipFilename);
            } catch (error) {
                console.error('打包下载时发生错误:', error);
                alert(translations[localStorage.getItem('currentLang') || 'zh']['downloadError']);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function extractFrame(time) {
            if (!videoPlayer.src || videoPlayer.readyState < 2) { // HAVE_CURRENT_DATA
                console.error(translations[localStorage.getItem('currentLang') || 'zh']['noVideoFile']);
                return;
            }
            if (time !== undefined) {
                videoPlayer.currentTime = time;
            }
            videoPlayer.addEventListener('seeked', function onSeeked() {
                ctx.drawImage(videoPlayer, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
                const imgDataUrl = hiddenCanvas.toDataURL('image/png');
                frameCounter++;
                const filename = `frame_at_${videoPlayer.currentTime.toFixed(2)}s_no_${frameCounter}.png`;

                const frameWrapper = document.createElement('div');
                frameWrapper.classList.add('frame-wrapper');
                frameWrapper.setAttribute('data-selected', 'false');
                frameWrapper.setAttribute('data-img-src', imgDataUrl); 
                frameWrapper.setAttribute('data-filename', filename); 

                const imgElement = document.createElement('img');
                imgElement.src = imgDataUrl;
                imgElement.alt = `Frame at ${videoPlayer.currentTime.toFixed(2)}s`;
                imgElement.classList.add('w-full', 'h-auto', 'object-contain', 'rounded');

                const timeOverlay = document.createElement('div');
                timeOverlay.classList.add('time-overlay');
                timeOverlay.textContent = `${videoPlayer.currentTime.toFixed(2)}s`;

                const selectionIndicator = document.createElement('div');
                selectionIndicator.classList.add('selection-indicator');
                selectionIndicator.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

                frameWrapper.appendChild(imgElement);
                frameWrapper.appendChild(timeOverlay);
                frameWrapper.appendChild(selectionIndicator);
                extractedFramesContainer.appendChild(frameWrapper);

                frameWrapper.addEventListener('click', () => {
                    const isSelected = frameWrapper.getAttribute('data-selected') === 'true';
                    frameWrapper.setAttribute('data-selected', !isSelected);
                    updateButtonStates(); 
                });
                videoPlayer.removeEventListener('seeked', onSeeked);
                updateButtonStates(); 
            }, { once: true }); 

            if (time === undefined) { // For "Extract Current Frame" when video might not need seeking
                if (videoPlayer.readyState >= 2) { // HAVE_CURRENT_DATA
                     ctx.drawImage(videoPlayer, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
                    const imgDataUrl = hiddenCanvas.toDataURL('image/png');
                    frameCounter++;
                    const filename = `frame_at_${videoPlayer.currentTime.toFixed(2)}s_no_${frameCounter}.png`;

                    const frameWrapper = document.createElement('div');
                    frameWrapper.classList.add('frame-wrapper');
                    frameWrapper.setAttribute('data-selected', 'false');
                    frameWrapper.setAttribute('data-img-src', imgDataUrl); 
                    frameWrapper.setAttribute('data-filename', filename);

                    const imgElement = document.createElement('img');
                    imgElement.src = imgDataUrl;
                    imgElement.alt = `Frame at ${videoPlayer.currentTime.toFixed(2)}s`;
                    imgElement.classList.add('w-full', 'h-auto', 'object-contain', 'rounded');

                    const timeOverlay = document.createElement('div');
                    timeOverlay.classList.add('time-overlay');
                    timeOverlay.textContent = `${videoPlayer.currentTime.toFixed(2)}s`;

                    const selectionIndicator = document.createElement('div');
                    selectionIndicator.classList.add('selection-indicator');
                    selectionIndicator.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

                    frameWrapper.appendChild(imgElement);
                    frameWrapper.appendChild(timeOverlay);
                    frameWrapper.appendChild(selectionIndicator);
                    extractedFramesContainer.appendChild(frameWrapper);

                    frameWrapper.addEventListener('click', () => {
                        const isSelected = frameWrapper.getAttribute('data-selected') === 'true';
                        frameWrapper.setAttribute('data-selected', !isSelected);
                        updateButtonStates(); 
                    });
                    updateButtonStates(); 
                }
            }
        }

        extractCurrentFrameBtn.addEventListener('click', () => {
            extractFrame(); 
        });

        extractIntervalFramesBtn.addEventListener('click', () => {
            const currentLang = localStorage.getItem('currentLang') || 'zh';
            if (!videoPlayer.src || videoPlayer.readyState < 2) {
                console.error(translations[currentLang]['noVideoFile']);
                return;
            }

            if (intervalExtractionTimer) {
                clearInterval(intervalExtractionTimer);
                intervalExtractionTimer = null;
                document.getElementById('extractIntervalFramesBtn').querySelector('span').textContent = translations[currentLang]['extractIntervalFrames'];
                console.log(translations[currentLang]['extractionComplete']);
                return; 
            }

            const interval = parseFloat(intervalInput.value);
            if (isNaN(interval) || interval <= 0) {
                alert(translations[currentLang]['alertInvalidInterval']);
                return;
            }

            document.getElementById('extractIntervalFramesBtn').querySelector('span').textContent = translations[currentLang]['stopExtraction'];
            let currentTime = 0;
            videoPlayer.currentTime = 0;

            const startExtraction = () => {
                if (currentTime <= videoDuration) {
                    extractFrame(currentTime);
                    currentTime += interval;
                } else {
                    clearInterval(intervalExtractionTimer);
                    intervalExtractionTimer = null;
                    document.getElementById('extractIntervalFramesBtn').querySelector('span').textContent = translations[currentLang]['extractIntervalFrames'];
                    console.log(translations[currentLang]['extractionComplete']);
                }
                updateButtonStates(); 
            };
            startExtraction();
            intervalExtractionTimer = setInterval(startExtraction, interval * 1000); 
        });

        clearFramesBtn.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
            const currentLang = localStorage.getItem('currentLang') || 'zh';
            confirmationModal.querySelector('[data-lang-key="confirmTitle"]').textContent = translations[currentLang]['confirmTitle'];
            confirmationModal.querySelector('[data-lang-key="confirmMessage"]').textContent = translations[currentLang]['confirmMessage'];
            confirmationModal.querySelector('[data-lang-key="confirmYes"]').textContent = translations[currentLang]['confirmYes'];
            confirmationModal.querySelector('[data-lang-key="confirmNo"]').textContent = translations[currentLang]['confirmNo'];
        });

        confirmClearBtn.addEventListener('click', () => {
            extractedFramesContainer.innerHTML = ''; 
            frameCounter = 0; 
            if (intervalExtractionTimer) {
                clearInterval(intervalExtractionTimer);
                intervalExtractionTimer = null;
                 const currentLang = localStorage.getItem('currentLang') || 'zh';
                document.getElementById('extractIntervalFramesBtn').querySelector('span').textContent = translations[currentLang]['extractIntervalFrames'];
            }
            confirmationModal.classList.add('hidden'); 
            updateButtonStates(); 
        });

        cancelClearBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden'); 
        });

        downloadAllFramesBtn.addEventListener('click', () => {
            const allFrames = extractedFramesContainer.querySelectorAll('.frame-wrapper');
            downloadFramesAsZip(allFrames, '所有抽帧.zip');
        });

        downloadSelectedFramesBtn.addEventListener('click', () => {
            const selectedFrames = extractedFramesContainer.querySelectorAll('.frame-wrapper[data-selected="true"]');
            if (selectedFrames.length === 0) {
                alert(translations[localStorage.getItem('currentLang') || 'zh']['alertSelectOneFrame']);
                return;
            }
            downloadFramesAsZip(selectedFrames, '选中抽帧.zip');
        });

        window.onbeforeunload = function() {
            if (extractedFramesContainer.children.length > 0) {
                return translations[localStorage.getItem('currentLang') || 'zh']['refreshConfirm'];
            }
        };
    </script>
</body>
</html>
